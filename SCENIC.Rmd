---
title: "Run Scenic"
author: "Jordi sce"
date: "2 november 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
dir.create("int")
dir.create("output")
options(stringsAsFactors = FALSE)
library(BiocGenerics)
library(SingleCellExperiment)
library(doRNG)
```

# Step 1: inferring potential TF targets based on co-expression
## Load and filter data
### Load expression matrix
```{r}
sce <- readRDS("data/reads_qc_scran_sc3.rds")
exprMat <- counts(sce)
dim(exprMat)
```

### Save cell information
```{r}
cellInfo <- colData(sce)[colnames(exprMat), "sc3_4_clusters", drop = F]
colVars <- list(sc3_4_clusters=setNames(c("forestgreen", "darkorange", "magenta4", "hotpink"), 
                                        c("FAP/MAB", "Schwann cells", "Satellite cells", "Smooth muscle cells")))
save(colVars, file="data/col.Vars.Rdata")
plot.new(); legend(0,1, fill=colVars$sc3_4_clusters, legend=names(colVars$sc3_4_clusters))
```

### Select organism
```{r}
org <- "mm9"
if(org=="hg19")
{
  library(RcisTarget.hg19.motifDatabases.20k)
  
  # Get genes in databases:
  data(hg19_500bpUpstream_motifRanking) # or 10kbp, they should have the same genes
  genesInDatabase <- hg19_500bpUpstream_motifRanking@rankings$rn
  
  # Get TFS in databases:
  data(hg19_direct_motifAnnotation)
  allTFs <- hg19_direct_motifAnnotation$allTFs
}

if(org=="mm9")
{
  library(RcisTarget.mm9.motifDatabases.20k)
  
  # Get genes in databases:
  data(mm9_500bpUpstream_motifRanking) # or 10kbp, they should have the same genes
  genesInDatabase <- mm9_500bpUpstream_motifRanking@rankings$rn
  
  # Get TFS in databases:
  data(mm9_direct_motifAnnotation)
  allTFs <- mm9_direct_motifAnnotation$allTFs
}
```

### Gene filter/selection
Dataset already filtered aforehand
```{r}
nCellsPerGene <- apply(exprMat, 1, function(x) sum(x>0))
nCountsPerGene <- apply(exprMat, 1, sum)
summary(nCellsPerGene)
summary(nCountsPerGene)
max(exprMat)
sum(exprMat>0) / sum(exprMat==0)
```

Remove genes with less than 70 counts (equivalent of 20 counts expressed in 1% of the total cells)
```{r}
minReads <- 20*.01*ncol(exprMat)
genesLeft_minReads <- names(nCountsPerGene)[which(nCountsPerGene > minReads)]
length(genesLeft_minReads)
```


Remove genes that are epxressed in less than 1% of the cells
```{r}
minSamples <- ncol(exprMat)*.01
nCellsPerGene2 <- nCellsPerGene[genesLeft_minReads]
genesLeft_minCells <- names(nCellsPerGene2)[which(nCellsPerGene2 > minSamples)]
length(genesLeft_minCells)
```

```{r}
genesLeft_minCells_inDatabases <- genesLeft_minCells[which(genesLeft_minCells %in% genesInDatabase)]
length(genesLeft_minCells_inDatabases)
```

Filter expression matrix
```{r}
exprMatrix_filtered <- exprMat[genesLeft_minCells_inDatabases, ]
save(exprMatrix_filtered, file="int/1.1_exprMatrix_filtered.RData")
```

Check whether any relevant gene/potential gene of interest is missing:
```{r}
interestingGenes <- c("Pax7", "Sox10", "Ly6a", "Gdf10", "Alpl")
interestingGenes[which(!interestingGenes %in% rownames(exprMatrix_filtered))]
```

```{r}
rm(exprMat)
```

### Potential regulators: list of transcription factors
```{r}
inputTFs <- allTFs[allTFs%in% rownames(exprMatrix_filtered)]
save(inputTFs, file="int/1.2_inputTFs.RData")

c(allTFs=length(allTFs), inputTFs=length(inputTFs))
```

## GENIE3
```{r}
# setwd("")
load("int/1.1_exprMatrix_filtered.RData")
# Optional: add log (if it is not logged already)
exprMatrix_filtered <- log2(exprMatrix_filtered+1) 
load("int/1.2_inputTFs.RData")
library(GENIE3)
```

### Run GENIE3
```{r}
set.seed(123)
weightMatrix <- GENIE3(exprMatrix_filtered, regulators=inputTFs, nCores=4)
save(weightMatrix, file="int/1.3_GENIE3_weightMatrix.RData")
```

### Correlation
```{r}
load("int/1.1_exprMatrix_filtered.RData")
corrMat <- cor(t(exprMatrix_filtered), method="spearman")
save(corrMat, file="int/1.4_corrMat.RData")
```

## Create co-expression modules
### Load output from GENIE3
```{r}
library(GENIE3)
# Convert the weight matrix into links:
load("int/1.3_GENIE3_weightMatrix.RData")
linkList <- getLinkList(weightMatrix, threshold=0.001) # (slighly faster)
# linkList <- getLinkList(weightMatrix)
colnames(linkList) <- c("TF", "Target", "weight")
# order by weight
linkList <- linkList[order(linkList[,"weight"], decreasing=TRUE),]
save(linkList, file="int/1.5_GENIE3_linkList.RData")
```

```{r}
load("int/1.5_GENIE3_linkList.RData")
dim(linkList)
head(linkList)
```

### Creating TF-modules (potential TF-targets)
#### Building gene-sets
```{r}
quantile(linkList$weight, probs=c(0.75, 0.90))
plot(linkList$weight[1:1000000], type="l", ylim=c(0, max(linkList$weight)), main="Weight of the links",
     ylab="Weight", xlab="Links sorted decreasingly")
abline(h=0.001, col="blue") # Threshold
sum(linkList$weight>0.001)/nrow(linkList)
```

```{r}
linkList_001 <- linkList[which(linkList[,"weight"]>0.001),]
# Number of links over the threshold: 
nrow(linkList_001) 
```

Create gene-sets and save
```{r}
tfModules <- list()

linkList_001$TF <- as.character(linkList_001$TF)
linkList_001$Target <- as.character(linkList_001$Target)
  
#### Create TF-modules:
# 1: Weight > 0.001 (filtered in previous step) 
tfModules[["w001"]] <- split(linkList_001$Target, factor(linkList_001$TF))

# 2: Weight > 0.005
llminW <- linkList_001[which(linkList_001[,"weight"]>0.005),]
tfModules[["w005"]] <- split(llminW$Target, factor(llminW$TF))

# 3: Top 50 targets for each TF
# ("w001" should be ordered decreasingly by weight)
tfModules[["top50"]] <- lapply(tfModules[["w001"]], function(x) x[1:(min(length(x), 50))])

# 4-6: Top regulators per target 
# (linkList_001 should be ordered by weight!)
linkList_001_byTarget <- split(linkList_001, factor(linkList_001$Target))
save(linkList_001_byTarget, file="int/1.5_linkList_001_byTarget.RData")

nTopTfs <- c(5, 10, 50)
nTopTfs <- setNames(nTopTfs, paste("top", nTopTfs, "perTarget", sep=""))

library(reshape2); library(data.table)
topTFsperTarget <- lapply(linkList_001_byTarget, function(llt) {
   nTFs <- nTopTfs[which(nTopTfs <= nrow(llt))]
   melt(lapply(nTFs, function(x) llt[1:x,"TF"]))
})
topTFsperTarget <- topTFsperTarget[which(!sapply(sapply(topTFsperTarget, nrow), is.null))]
topTFsperTarget.asDf <-  data.frame(rbindlist(topTFsperTarget, idcol=TRUE))
head(topTFsperTarget.asDf)
colnames(topTFsperTarget.asDf) <- c("Target", "TF", "method")

# Merge the all the gene-sets:
tfModules.melted <- melt(tfModules)
colnames(tfModules.melted) <- c("Target", "TF", "method")
tfModules <- rbind(tfModules.melted, topTFsperTarget.asDf)

save(tfModules, file="int/1.6_tfModules.RData")
```

```{r}
load("int/1.6_tfModules.RData")
# Basic counts:
rbind(nGeneSets=nrow(tfModules), 
      nTFs=length(unique(tfModules$TF)), 
      nTargets=length(unique(tfModules$Target)))
```

#### Split into positive- and negative-correlated targets
Split TF targets according to correlation
```{r}
load("int/1.4_corrMat.RData")
# Keep only correlation between TFs and potential targets
tfs <- unique(tfModules$TF)
corrMat <- corrMat[tfs,]

# Split TF modules according to correlation
tfModules_byTF <- split(tfModules, factor(tfModules$TF))
tfModules_withCorr_byTF <- lapply(tfModules_byTF, function(tfGeneSets)
{
    tf <- unique(tfGeneSets$TF)
    targets <- tfGeneSets$Target
    cbind(tfGeneSets, corr=c(as.numeric(corrMat[tf,targets] > 0.03) - as.numeric(corrMat[tf,targets] < -0.03)))
})
tfModules_withCorr <- data.frame(rbindlist(tfModules_withCorr_byTF))
save(tfModules_withCorr, file="int/1.7_tfModules_withCorr.RData")
```

```{r}
load("int/1.7_tfModules_withCorr.RData")
head(tfModules_withCorr)
dim(tfModules_withCorr)
```

# Step 2: identifying regulons (direct TF targets) based on DNA motif enrichment
## Load gene sets
```{r}
load("int/1.7_tfModules_withCorr.RData")

# Remove genes missing from RcisTarget databases
#  (In case the input matrix wasn't already filtered)
tfModules_withCorr <- tfModules_withCorr[which(as.character(tfModules_withCorr$TF) %in% allTFs),]
geneInDb <- tfModules_withCorr$Target %in% genesInDatabase
# Genes in co-expression modules not available in RcisTargetDatabases:
missingGenes <- sort(unique(tfModules_withCorr[which(!geneInDb),"Target"]))
missingGenes
tfModules_withCorr <- tfModules_withCorr[which(geneInDb),]
    
# Targets with positive correlation
tfModules_Selected <- tfModules_withCorr[which(tfModules_withCorr$corr==1),]

# Add a column with the geneSet name (TF_method)
tfModules_Selected <- cbind(tfModules_Selected, geneSetName=paste(tfModules_Selected$TF, tfModules_Selected$method, sep="_"))
head(tfModules_Selected)

# Split into tfModules (TF-modules, with several methods)
tfModules <- split(tfModules_Selected$Target, tfModules_Selected$geneSetName)

# Keep gene sets with at least 20 genes
tfModules <- tfModules[which(lengths(tfModules)>=20)]

# Add TF to the gene set (used in the following steps, careful if editing)
tfModules <- setNames(lapply(names(tfModules), function(gsn) {
    tf <- strsplit(gsn, "_")[[1]][1]
    unique(c(tf, tfModules[[gsn]]))
    }), names(tfModules))
save(tfModules, file="int/2.1_tfModules_forMotifEnrichmet.RData")
```

```{r}
load("int/2.1_tfModules_forMotifEnrichmet.RData")
tfModulesSummary <- t(sapply(strsplit(names(tfModules), "_"), function(x) x[1:2]))
sort(table(tfModulesSummary[,2]))
```

## Motif enrichment analysis & identifying direct targets
### Motif databases
```{r}
org <- "mm9"
if(org=="hg19")
{
    library(RcisTarget.hg19.motifDatabases.20k)
    
    # Motif rankings (genes x motifs)
    data(hg19_500bpUpstream_motifRanking)
    data(hg19_10kbpAroundTss_motifRanking)
    motifRankings <- list()
    motifRankings[["500bp"]] <- hg19_500bpUpstream_motifRanking
    motifRankings[["10kbp"]] <- hg19_10kbpAroundTss_motifRanking
    
    # Motif annotation (TFs)
    data(hg19_direct_motifAnnotation)
    direct_motifAnnotation <- hg19_direct_motifAnnotation
    data(hg19_inferred_motifAnnotation) # optional
    inferred_motifAnnotation <- hg19_inferred_motifAnnotation
}

if(org=="mm9")
{
    library(RcisTarget.mm9.motifDatabases.20k)
    
    # Motif rankings (genes x motifs)
    data(mm9_500bpUpstream_motifRanking)
    data(mm9_10kbpAroundTss_motifRanking)
    motifRankings <- list()
    motifRankings[["500bp"]] <- mm9_500bpUpstream_motifRanking
    motifRankings[["10kbp"]] <- mm9_10kbpAroundTss_motifRanking
    
    # Motif annotation (TFs)
    data(mm9_direct_motifAnnotation)
    direct_motifAnnotation <- mm9_direct_motifAnnotation
    data(mm9_inferred_motifAnnotation) # optional
    inferred_motifAnnotation <- mm9_inferred_motifAnnotation
}
```

### Run RCisTarget
```{r}
library(RcisTarget)
################################################################
# 1. Calculate motif enrichment for each TF-module

### 1.1 Calculate enrichment
motifs_AUC <- lapply(motifRankings, function(ranking) calcAUC(tfModules, ranking, aucMaxRank=0.01*nrow(ranking@rankings), nCores=4, verbose=FALSE))
save(motifs_AUC, file="int/2.2_motifs_AUC_500bp_10kbp.RData")

### 1.2 Conver to table, filter by NES & add the TFs to which the motif is annotated
# (For each database...)
motifEnrichment <- lapply(motifs_AUC, function(aucOutput)
{
  # Extract the TF of the gene-set name (i.e. MITF_w001):
  tf <- sapply(setNames(strsplit(rownames(aucOutput), "_"), rownames(aucOutput)), function(x) x[[1]])
  
  # Calculate NES and add motif annotation (provide tf in 'highlightTFs'):
  addMotifAnnotation(aucOutput, highlightTFs=tf, nesThreshold=3.0, digits=3,
                  motifAnnot_direct=direct_motifAnnotation,
                  motifAnnot_inferred=inferred_motifAnnotation)
})

# Merge both tables, adding a column that contains the 'motifDb' 
motifEnrichment <- do.call(rbind, lapply(names(motifEnrichment), function(dbName){
  cbind(motifDb=dbName, motifEnrichment[[dbName]])
}))
save(motifEnrichment, file="int/2.3_motifEnrichment.RData")
cat("Number of motifs in the initial enrichment: ", nrow(motifEnrichment))

### 1.3 Keep only the motifs annotated to the initial TF
motifEnrichment_selfMotifs <- motifEnrichment[which(motifEnrichment$TFinDB != ""),, drop=FALSE]
save(motifEnrichment_selfMotifs, file="int/2.4_motifEnrichment_selfMotifs.RData")
cat("Number of motifs annotated to the initial TF: ", nrow(motifEnrichment_selfMotifs))
rm(motifEnrichment)

################################################################
# 2. Prune targets

motifEnrichment_selfMotifs_wGenes <- lapply(names(motifRankings), function(motifDbName){
  addSignificantGenes(resultsTable=motifEnrichment_selfMotifs[motifDb==motifDbName],
                      geneSets=tfModules,
                      rankings=motifRankings[[motifDbName]],
                      maxRank=5000, method="aprox", nCores=4)
  })

library(data.table)
motifEnrichment_selfMotifs_wGenes <- rbindlist(motifEnrichment_selfMotifs_wGenes)
save(motifEnrichment_selfMotifs_wGenes, file="int/2.5_motifEnrichment_selfMotifs_wGenes.RData")

# Save as text:
write.table(motifEnrichment_selfMotifs_wGenes, file="output/Step2_MotifEnrichment.tsv", 
            sep="\t", quote=FALSE, row.names=FALSE)
```

